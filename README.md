# Docker and Minikube

# 0. Prerequisites
Что нужно сделать перед прохождением блока:
- Установить Docker Desktop для своей системы (для Linux необязательно).
- Зарегистрировать аккаунт на [Docker Hub](https://hub.docker.com).
- Установить Minikube для своей системы по [инструкции](https://kubernetes.io/ru/docs/tasks/tools/install-minikube/).
При запуск Minikube можно в качестве драйвера использовать docker (--vm-driver=docker), для этого должен быть запущен Docker Daemon (например, с помощью Docker Desktop).

# 1. Docker
Классический вопрос с собеседования - в чём разница виртуальной машины и контейнера/Docker?
Ответ, как всегда, можно посмотреть на [Wiki](https://ru.wikipedia.org/wiki/Контейнеризация), нас же интересует, как пользоваться Docker.

Всё начинается с написания Dockerfile. Dockerfile - "инструкция" по сборке образа, из которого будет запускаться контейнер. Образ - готовый и упакованный набор ПО, готовый к развёртыванию.

Образ состоит из слоёв. Слой - команда, результат выполнения которой можно переиспользовать, например, результат команды
`RUN dotnet build`. Не всякая команда создаёт слой (вообще, только четыре команды могут это делать: `FROM`, `RUN`, `COPY`, и `ADD`).
Все команды можно посмотреть [здесь](https://docs.docker.com/reference/dockerfile/).
У образа может быть базовый образ, с которого начинается сборка (задаётся командой `FROM`). Это часто бывамет удобно, потому что не нужно заново устанавливать всё ПО, необходимое для работы.
Пример базовых образов - `dotnet/aspnet:8.0` и `dotnet/sdk:8.0`.

Заметим, что название образа (или, по-другому, тег) чаще всего состоит из названия пользователя/организации, названия самого образа и версии. Версия может задаваться в произвольном формате, но всегда она следует после `:`.

Давай попробуем собрать свой образ!

### 1.1. Создаём Docker-образ
Для начала добавь в репозиторий файл Dockerfile (это стандартное название файла). Работать будем с текущим проектов WebApp.
Теперь нужно сделать следующее:
- добавить базовый образ (адрес - mcr.microsoft.com/dotnet/aspnet:8.0-alpine);
- выставить наружу порт приложения (обычно 8080);
- restore Nuget-пакетов (тут уже нужен новый базовый образ, да, их может быть несколько, -- mcr.microsoft.com/dotnet/sdk:8.0);
- билд для проверки того, что приложение билдится;
- паблиш приложения (в виде exe либо dll, со вторым будет проще выполнять дальнейшие действия);
- выставить приложение в качестве entry-point контейнера.
Для первого используй команду `FROM`, для второго - `EXPOSE`, для остальных - `WORKDIR`, `RUN` и, возможно, `COPY`. Для последнего пункта - `ENTRYPOINT`.

Проверь сборку контейнера командой `docker build .` либо запуском файла в Rider. Если нет ошибок, можно двигаться дальше.

### 1.2. Пробуем запустить контейнер
После сборки контейнера скопируй id полученного образа (он будет в логах сборки или в Rider), после чего выполни команду
`docker run <id_образа>`. Если на предыдущем этапе всё сделано правильно, увидишь логи запуска приложения dotnet.

### 1.3. (MacOS warning!) Пробуем получить доступ к сервису в контейнере
Если у тебя MacOS, этот пункт выполнить целиком не получится из-за бага в Docker для MacOS, который не даёт полноценно пробрасывать порты между хостом и контейнером.

Останови контейнер и выполни команду `docker run <id_образа> -p 50121:8080`. Вместо 50121 может быть произвольный свободный порт в твоей системе.
Если всё ок, по адресу `http://localhost:50121/WeatherForecast` откроется результат выполнения запроса к методу API нашего приложения.
Если у тебя MacOS и всё ок, вместо ответа ты увидишь 403 Forbidden (из-за Docker).
